<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>users</title>
    <link rel="stylesheet" href="css/site.css" />
</head>

<body>
    <header style="max-width:820px;margin:0 auto 1rem;display:flex;justify-content:space-between;align-items:center;">
        <div id="greeting" style="color:#7a5863;font-weight:500;"></div>
        <div><!-- no login/logout buttons per request --></div>
    </header>

    <div id="inlineLogin" class="login-card" style="max-width:520px;margin:1rem auto;display:none;">
        <form id="inlineLoginForm" action="javascript:void(0);" onsubmit="handleInlineLogin(event)">
            <input id="inline-username" type="text" placeholder="砖 砖转砖" required />
            <input id="inline-password" type="password" placeholder="住住" required />
            <input class="login-submit" type="submit" value="转专" />
            <p id="inline-error" style="color:#b91c1c;margin-top:0.5rem;display:none"></p>
        </form>
    </div>

    <div id="protectedContent" style="display:none;">
        <h3 onclick="location.href='index.html'">转</h3>
        <h1>User</h1>
        <h3>Add User</h3>
        <form id="addForm" action="javascript:void(0);" method="POST" onsubmit="addItem()">
            <input type="text" id="add-name" placeholder="New user">
            <input type="submit" value="Add">
        </form>

        <div id="editForm">
            <h3>Edit</h3>
            <form action="javascript:void(0);" onsubmit="updateItem()">
                <input type="hidden" id="edit-id">
                <input type="text" id="edit-name">
                <input type="submit" value="Save">
                <a onclick="closeInput()" aria-label="Close">&#10006;</a>
            </form>
        </div>

        <p id="counter"></p>

        <table>
            <tr>
                <th>Name</th>
                <th></th>
                <th></th>
            </tr>
            <tbody id="users"></tbody>
        </table>
    </div>

    <script>
        function getToken() { return localStorage.getItem('token'); }
        function removeToken() { localStorage.removeItem('token'); }
        function getPayloadFromToken() {
            const token = getToken();
            if (!token) return null;
            const parts = token.split('.');
            if (parts.length < 2) return null;
            try {
                const base64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(atob(base64));
            } catch (e) { return null; }
        }
        function getUserName() { const p = getPayloadFromToken(); if (!p) return null; return p.name || p.unique_name || p.username || p.sub || null; }

        document.addEventListener('DOMContentLoaded', () => {
            const greetingEl = document.getElementById('greeting');
            const protectedEl = document.getElementById('protectedContent');
            const inlineLogin = document.getElementById('inlineLogin');

            function showProtected() {
                if (inlineLogin) inlineLogin.style.display = 'none';
                if (protectedEl) protectedEl.style.display = 'block';
                const currentName = getUserName();
                if (getToken()) {
                    getItems();
                }
            }

            function showLogin() {
                if (inlineLogin) inlineLogin.style.display = 'block';
                if (protectedEl) protectedEl.style.display = 'none';
                greetingEl.innerText = '';
            }

            if (getToken()) {
                showProtected();
            } else {
                showLogin();
            }

            window.showInlineLogin = showLogin;
        });
    </script>

    <script src="js/siteUser.js" asp-append-version="true"></script>
    <script type="text/javascript">
        if (getToken()) {
            getItems();
        }
    </script>
</body>

</html>